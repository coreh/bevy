<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Bevy Remote Protocol (BRP) Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        * {
            font-family: system-ui;
            box-sizing: border-box;
        }

        :root {
            --ui-01: #18181a;
            --ui-02: #232326;
            --ui-03: #39393e;
            --ui-04: #7c7c87;
            --ui-05: #ffffff;
            --ui-error: #cc3b40;
            --ui-warning: #f8a34e;
            --ui-success: #6bc46d;
            font-size: 14px;
            background: var(--ui-02);
            color: var(--ui-05);
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        button,
        select {
            display: block;
            appearance: none;
            background-color: var(--ui-03);
            border: none;
            border-radius: 0.5rem;
            padding: 0.3rem 1rem;
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.04s ease-in-out;
            margin: 0;
        }

        .select-wrapper {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .select-wrapper::after {
            content: "‚è∑";
            position: absolute;
            right: 0.8rem;
            top: 50%;
            pointer-events: none;
            transform: translateY(-50%);
        }

        button:hover {
            filter: brightness(1.2);
        }

        button:active {
            filter: brightness(0.8);
        }

        input,
        textarea {
            padding: 10px;
            font-size: inherit;
            outline: none;
            display: block;
            border: none;
            font-family: monospace;
            background: var(--ui-01);
            color: var(--ui-05);
            border-radius: 0.5rem;
        }

        textarea {
            resize: none;
            width: 100%;
            min-width: 100%;
            flex-grow: 1;
        }

        label {
            color: var(--ui-04);
        }

        section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            height: 100%;
            padding: 10px;
        }

        h1 {
            margin: 0;
            padding: 0;
            font-size: 1.5rem;
        }
    </style>
</head>

<body>
    <section>
        <h1>Bevy Remote Protocol (BRP) Tool</h1>
        <label for="request">Request</label>
        <div class="select-wrapper">
            <select>
                <option value="ping">Ping</option>
                <hr>
                <option value="query-all-entities">Query: All Entities</option>
                <option value="query-point-lights">Query: Point Lights</option>
                <option value="query-ui-text">Query: UI Text</option>
                <option value="query-non-ui">Query: Non-UI Entities</option>
                <option value="query-root-entities">Query: Root Entities</option>
                <option value="query-has-mesh">Query: Has Mesh?</option>
                <option value="query-optional-names">Query: Optional Names</option>
                <hr>
                <option value="insert-point-light">Insert: Point Light</option>
                <option value="insert-transform">Insert: Cube Transform</option>
                <hr>
                <option value="invalid">Invalid Request</option>
                <option value="unimplemented">Unimplemented Request</option>
            </select>
        </div>
        <textarea id="request" placeholder="Request Payload (JSON)"></textarea>
        <button id="send">Submit</button>
        <label for="query">Response</label>
        <textarea readonly id="result" style="flex-grow: 2" placeholder=" Response Payload (JSON)"></textarea>
    </section>

    <script>
        document.querySelector('#send').addEventListener('click', async () => {
            let request = document.querySelector('#request').value;
            try {
                const requestJSON = JSON.parse(request);
                request = JSON.stringify(requestJSON, function (key, value) {
                    if (key === 'components' && typeof value === 'object') {
                        const result = {};
                        for (const [childKey, childValue] of Object.entries(value)) {
                            result[childKey] = { JSON: JSON.stringify(childValue) };
                        }
                        return result;
                    }
                    return value;
                }, 2);
                console.log(request);
            } catch (e) {
                reportError(e);
            }
            const res = await fetch('/brp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: request,
            });
            const json = JSON.parse(await res.text(), (key, value) => {
                if (value?.JSON) {
                    let nestedValue = JSON.parse(value.JSON);
                    if (typeof nestedValue === 'object') {
                        const firstKey = Object.keys(nestedValue)[0];
                        return nestedValue[firstKey];
                    }
                    return nestedValue;
                }
                return value;
            });

            const resultTextarea = document.querySelector('#result');
            resultTextarea.value = JSON.stringify(json, null, 2);
            if (res.status >= 500) {
                resultTextarea.style.color = 'var(--ui-error)';
            } else if (res.status >= 400) {
                resultTextarea.style.color = 'var(--ui-warning)';
            } else {
                resultTextarea.style.color = 'var(--ui-success)';
            }
        });

        const EXAMPLES = {
            'ping': {
                request: 'PING',
            },
            'query-all-entities': {
                request: 'QUERY',
                params: {},
            },
            'query-point-lights': {
                request: 'QUERY',
                params: {
                    data: {
                        components: ['PointLight'],
                    },
                },
            },
            'query-ui-text': {
                request: 'QUERY',
                params: {
                    data: {
                        components: ['Text'],
                    },
                    filter: {
                        with: ['Node'],
                    },
                },
            },
            'query-non-ui': {
                request: 'QUERY',
                params: {
                    filter: {
                        without: ['Node'],
                    },
                },
            },
            'query-root-entities': {
                request: 'QUERY',
                params: {
                    filter: {
                        without: ['Parent'],
                    },
                },
            },
            'query-has-mesh': {
                request: 'QUERY',
                params: {
                    data: {
                        has: ['Handle<Mesh>'],
                    },
                },
            },
            'query-optional-names': {
                request: 'QUERY',
                params: {
                    data: {
                        optional: ['Name'],
                    },
                },
            },
            'insert-point-light': {
                request: 'INSERT',
                params: {
                    entity: '3v0',
                    components: {
                        PointLight: {
                            color: {
                                Rgba: {
                                    red: 1,
                                    green: 0,
                                    blue: 0,
                                    alpha: 1
                                }
                            },
                            intensity: 1500,
                            range: 20,
                            radius: 0,
                            shadows_enabled: true,
                            shadow_depth_bias: 0.02,
                            shadow_normal_bias: 0.6
                        }
                    },
                },
            },
            'insert-transform': {
                request: 'INSERT',
                params: {
                    entity: '2v0',
                    components: {
                        Transform: {
                            translation: {
                                x: 0,
                                y: 1,
                                z: 0
                            },
                            rotation: {
                                x: 0,
                                y: 0,
                                z: 0,
                                w: 1
                            },
                            scale: {
                                x: 1,
                                y: 1,
                                z: 1
                            }
                        }
                    },
                },
            },
            'invalid': {
                request: 'FOO',
            },
            'unimplemented': {
                request: 'POLL',
                params: {
                    data: {
                        components: ['PointLight'],
                    },
                },
            },
        };

        document.querySelector('select').addEventListener('change', handleSelectChange);

        function handleSelectChange(e) {
            const value = e.target.value;
            const json = EXAMPLES[value] || {};
            document.querySelector('#request').value = JSON.stringify(json, null, 2);
        }

        document.querySelector('select').dispatchEvent(new Event('change'));

    </script>

</body>
